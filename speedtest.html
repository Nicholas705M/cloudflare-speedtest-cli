<!DOCTYPE html>
<html>
<head>
    <title>Cloudflare Speedtest</title>
    <script type="module">
        import SpeedTest from './node_modules/@cloudflare/speedtest/dist/speedtest.js';

        const speedtest = new SpeedTest({
            autoStart: false,
            measurements: [{
                    type: 'latency',
                    numPackets: 20
                },
                {
                    type: 'download',
                    bytes: 1e5,
                    count: 9
                },
                {
                    type: 'download',
                    bytes: 1e6,
                    count: 8
                },
                {
                    type: 'upload',
                    bytes: 1e5,
                    count: 8
                },
                {
                    type: 'packetLoss',
                    numPackets: 1e3,
                    responsesWaitTime: 3000
                },
                {
                    type: 'upload',
                    bytes: 1e6,
                    count: 6
                },
                {
                    type: 'download',
                    bytes: 1e7,
                    count: 6
                },
            ]
        });

        speedtest.onFinish = results => {
            const summary = results.getSummary();
            const output = {
                download: summary.download,
                upload: summary.upload,
                ping: summary.latency,
                jitter: summary.jitter,
                packetLoss: summary.packetLoss,
                loadedLatency: summary.downLoadedLatency,
            };
            console.log(JSON.stringify(output));
        };

        speedtest.onError = error => {
            console.error(JSON.stringify({
                error: error
            }));
        };

        // Start the speed test after the page loads
        window.addEventListener('load', () => {
            speedtest.play();
        });
    </script>
</head>
<body>
    <h1>Cloudflare Speedtest Running...</h1>
    <p>Check console for results.</p>
</body>
</html>
